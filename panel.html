<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JyX Bot Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'gg sans', 'Noto Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #313338;
            color: #dbdee1;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            background: #2b2d31;
            padding: 16px 20px;
            border-bottom: 1px solid #1e1f22;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #f2f3f5;
        }

        .header .by-tury {
            font-size: 12px;
            color: #949ba4;
            font-style: italic;
        }

        /* Main container */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 240px;
            background: #2b2d31;
            border-right: 1px solid #1e1f22;
            display: flex;
            flex-direction: column;
        }

        .sidebar-section {
            padding: 16px 8px 8px;
        }

        .sidebar-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: #949ba4;
            padding: 0 8px;
            margin-bottom: 4px;
        }

        .sidebar-item {
            padding: 6px 8px;
            margin: 1px 0;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            color: #949ba4;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sidebar-item:hover {
            background: #404249;
            color: #dbdee1;
        }

        .sidebar-item.active {
            background: #404249;
            color: #fff;
        }

        .sidebar-item .icon {
            font-size: 20px;
        }

        /* Content area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .content-header {
            padding: 12px 16px;
            border-bottom: 1px solid #1e1f22;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 16px;
            font-weight: 600;
            color: #f2f3f5;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .content-body {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* Search box */
        .search-box {
            width: 100%;
            padding: 10px 12px;
            background: #1e1f22;
            border: none;
            border-radius: 4px;
            color: #dbdee1;
            font-size: 14px;
            margin-bottom: 12px;
        }

        .search-box:focus {
            outline: none;
            background: #111214;
        }

        /* List items */
        .list-item {
            background: #2b2d31;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .list-item:hover {
            background: #404249;
            border-color: #404249;
        }

        .list-item-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .list-item-content {
            flex: 1;
            min-width: 0;
        }

        .list-item-name {
            font-weight: 500;
            color: #f2f3f5;
            font-size: 14px;
            margin-bottom: 2px;
        }

        .list-item-id {
            font-size: 12px;
            color: #949ba4;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .list-item-badge {
            background: #5865f2;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background: #111214;
            border-radius: 4px;
            padding: 6px 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            display: none;
            min-width: 200px;
        }

        .context-menu-item {
            padding: 8px 8px;
            cursor: pointer;
            transition: all 0.1s ease;
            color: #dbdee1;
            border-radius: 2px;
            font-size: 14px;
        }

        .context-menu-item:hover {
            background: #5865f2;
            color: #fff;
        }

        .context-menu-divider {
            height: 1px;
            background: #3f4147;
            margin: 4px 0;
        }

        /* Buttons */
        .btn {
            padding: 10px 16px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.17s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #5865f2;
            color: #fff;
        }

        .btn-primary:hover {
            background: #4752c4;
        }

        .btn-success {
            background: #23a559;
            color: #fff;
        }

        .btn-success:hover {
            background: #1e8e4f;
        }

        .btn-danger {
            background: #da373c;
            color: #fff;
        }

        .btn-danger:hover {
            background: #a92d31;
        }

        .btn-secondary {
            background: #4e5058;
            color: #fff;
        }

        .btn-secondary:hover {
            background: #6d6f78;
        }

        /* Form elements */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #b5bac1;
            text-transform: uppercase;
            font-size: 12px;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: #1e1f22;
            border: 1px solid #1e1f22;
            border-radius: 4px;
            color: #dbdee1;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #5865f2;
        }

        .form-textarea {
            min-height: 300px;
            resize: vertical;
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .alert-success {
            background: #23a55926;
            color: #23a559;
            border: 1px solid #23a559;
        }

        .alert-error {
            background: #f2383526;
            color: #f23f42;
            border: 1px solid #f23f42;
        }

        /* Loader */
        .loader {
            border: 3px solid #2b2d31;
            border-top: 3px solid #5865f2;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 40px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Config grid */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 16px;
        }

        .config-card {
            background: #2b2d31;
            border-radius: 4px;
            padding: 16px;
        }

        .config-card-title {
            font-size: 14px;
            font-weight: 600;
            color: #f2f3f5;
            margin-bottom: 12px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 16px;
        }

        ::-webkit-scrollbar-track {
            background: #2b2d31;
        }

        ::-webkit-scrollbar-thumb {
            background: #1a1b1e;
            border-radius: 8px;
            border: 4px solid #2b2d31;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #18191c;
        }

        /* Done button container */
        .done-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 999;
        }

        .done-btn {
            background: #111214;
            color: #fff;
            padding: 14px 24px;
            border-radius: 24px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid #5865f2;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
            transition: all 0.2s ease;
        }

        .done-btn:hover {
            background: #5865f2;
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(88, 101, 242, 0.4);
        }
    </style>
</head>
<body>
    <div id="contextMenu" class="context-menu"></div>

    <div class="header">
        <h1>🎛️ JyX Bot Control Panel</h1>
        <span class="by-tury">by Tury</span>
    </div>

    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Server</div>
                <div class="sidebar-item active" onclick="switchTab('channels')">
                    <span class="icon">#</span>
                    <span>Channels</span>
                </div>
                <div class="sidebar-item" onclick="switchTab('roles')">
                    <span class="icon">🎭</span>
                    <span>Roles</span>
                </div>
                <div class="sidebar-item" onclick="switchTab('members')">
                    <span class="icon">👥</span>
                    <span>Members</span>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Management</div>
                <div class="sidebar-item" onclick="switchTab('config')">
                    <span class="icon">⚙️</span>
                    <span>Configuration</span>
                </div>
                <div class="sidebar-item" onclick="switchTab('scripts')">
                    <span class="icon">📜</span>
                    <span>Scripts</span>
                </div>
                <div class="sidebar-item" onclick="switchTab('tickets')">
                    <span class="icon">🎫</span>
                    <span>Tickets</span>
                </div>
            </div>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Channels Tab -->
            <div id="channels" class="tab-content active">
                <div class="content-header">
                    <div class="content-title">
                        <span>#</span>
                        <span>Channels</span>
                    </div>
                </div>
                <div class="content-body">
                    <input type="text" class="search-box" placeholder="Search channels..." onkeyup="filterList('channelsList', this.value)">
                    <div id="channelsList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Roles Tab -->
            <div id="roles" class="tab-content">
                <div class="content-header">
                    <div class="content-title">
                        <span>🎭</span>
                        <span>Roles</span>
                    </div>
                </div>
                <div class="content-body">
                    <input type="text" class="search-box" placeholder="Search roles..." onkeyup="filterList('rolesList', this.value)">
                    <div id="rolesList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Members Tab -->
            <div id="members" class="tab-content">
                <div class="content-header">
                    <div class="content-title">
                        <span>👥</span>
                        <span>Members</span>
                    </div>
                </div>
                <div class="content-body">
                    <input type="text" class="search-box" placeholder="Search members..." onkeyup="filterList('membersList', this.value)">
                    <div id="membersList">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Config Tab -->
            <div id="config" class="tab-content">
                <div class="content-header">
                    <div class="content-title">
                        <span>⚙️</span>
                        <span>Configuration</span>
                    </div>
                    <button class="btn btn-success" onclick="saveConfig()">💾 Save & Reload</button>
                </div>
                <div class="content-body">
                    <div id="configAlert"></div>
                    <div class="config-grid">
                        <div class="config-card">
                            <div class="config-card-title">General Settings</div>
                            <div class="form-group">
                                <label class="form-label">Clan Name</label>
                                <input type="text" class="form-input" id="clanName" placeholder="JyX">
                            </div>
                        </div>
                        <div class="config-card">
                            <div class="config-card-title">Advanced</div>
                            <div class="form-group">
                                <label class="form-label">Full Config JSON</label>
                                <textarea class="form-textarea" id="configJson"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scripts Tab -->
            <div id="scripts" class="tab-content">
                <div class="content-header">
                    <div class="content-title">
                        <span>📜</span>
                        <span>Scripts</span>
                    </div>
                </div>
                <div class="content-body">
                    <div id="scriptAlert"></div>
                    <div class="form-group">
                        <label class="form-label">Script ID</label>
                        <input type="text" class="form-input" id="scriptId" placeholder="SCR-12345678">
                    </div>
                    <button class="btn btn-primary" onclick="viewScript()">View Script</button>
                    <div id="scriptResult"></div>
                </div>
            </div>

            <!-- Tickets Tab -->
            <div id="tickets" class="tab-content">
                <div class="content-header">
                    <div class="content-title">
                        <span>🎫</span>
                        <span>Tickets</span>
                    </div>
                </div>
                <div class="content-body">
                    <div id="ticketAlert"></div>
                    <div class="form-group">
                        <label class="form-label">Ticket ID</label>
                        <input type="text" class="form-input" id="ticketId" placeholder="TKT-12345678">
                    </div>
                    <button class="btn btn-primary" onclick="viewTicket()">View Ticket</button>
                    <button class="btn btn-secondary" onclick="downloadTicket()">Download HTML</button>
                    <div id="ticketPreview" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Done Button -->
    <div class="done-container">
        <button class="done-btn" onclick="closePanel()">✓ Done</button>
    </div>

    <script>
        let serverData = null;
        let currentConfig = null;
        let contextTarget = null;

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.sidebar-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.closest('.sidebar-item').classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Load server data
        async function loadServerData() {
            try {
                const response = await fetch('/api/server-data');
                serverData = await response.json();

                renderChannels();
                renderRoles();
                renderMembers();
            } catch (e) {
                console.error('Error loading server data:', e);
            }
        }

        function renderChannels() {
            const container = document.getElementById('channelsList');
            if (!serverData?.channels) return;

            container.innerHTML = serverData.channels.map(ch => `
                <div class="list-item" data-name="${ch.name}" data-type="channel" oncontextmenu="showContextMenu(event, '${ch.id}', '${ch.name}', 'channel')">
                    <span class="list-item-icon">#</span>
                    <div class="list-item-content">
                        <div class="list-item-name">${ch.name}</div>
                        <div class="list-item-id">${ch.id}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderRoles() {
            const container = document.getElementById('rolesList');
            if (!serverData?.roles) return;

            container.innerHTML = serverData.roles.map(role => `
                <div class="list-item" data-name="${role.name}" data-type="role" oncontextmenu="showContextMenu(event, '${role.id}', '${role.name}', 'role')">
                    <span class="list-item-icon">🎭</span>
                    <div class="list-item-content">
                        <div class="list-item-name">${role.name}</div>
                        <div class="list-item-id">${role.id}</div>
                    </div>
                </div>
            `).join('');
        }

        function renderMembers() {
            const container = document.getElementById('membersList');
            if (!serverData?.members) return;

            container.innerHTML = serverData.members.slice(0, 100).map(member => `
                <div class="list-item" data-name="${member.display_name}" data-type="member" oncontextmenu="showContextMenu(event, '${member.id}', '${member.display_name}', 'member')">
                    <img src="${member.avatar}" style="width: 32px; height: 32px; border-radius: 50%;" class="list-item-icon">
                    <div class="list-item-content">
                        <div class="list-item-name">${member.display_name}</div>
                        <div class="list-item-id">${member.id}</div>
                    </div>
                    ${currentConfig?.admin_users?.includes(parseInt(member.id)) ? '<span class="list-item-badge">ADMIN</span>' : ''}
                </div>
            `).join('');
        }

        // Context menu
        function showContextMenu(e, id, name, type) {
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            contextTarget = {id, name, type};

            let menuItems = '';
            if (type === 'channel') {
                menuItems = `
                    <div class="context-menu-item" onclick="assignTo('channels.welcome')">Set as Welcome Channel</div>
                    <div class="context-menu-item" onclick="assignTo('channels.mod_log')">Set as Mod Log</div>
                    <div class="context-menu-item" onclick="assignTo('channels.ticket_panel')">Set as Ticket Panel</div>
                    <div class="context-menu-item" onclick="assignTo('channels.transcript')">Set as Transcript Channel</div>
                    <div class="context-menu-item" onclick="assignTo('channels.rankup')">Set as Rankup Channel</div>
                `;
            } else if (type === 'role') {
                menuItems = `
                    <div class="context-menu-item" onclick="assignTo('roles.team')">Set as Team Role</div>
                    <div class="context-menu-item" onclick="assignTo('roles.mute')">Set as Mute Role</div>
                    <div class="context-menu-item" onclick="assignTo('roles.partner')">Set as Partner Role</div>
                    <div class="context-menu-item" onclick="assignTo('roles.giveaway')">Set as Giveaway Role</div>
                `;
            } else if (type === 'member') {
                const isAdmin = currentConfig?.admin_users?.includes(parseInt(id));
                menuItems = `
                    <div class="context-menu-item" onclick="${isAdmin ? 'removeFromAdmins()' : 'addToAdmins()'}">
                        ${isAdmin ? 'Remove from Admin Users' : 'Add to Admin Users'}
                    </div>
                    <div class="context-menu-divider"></div>
                    <div class="context-menu-item" onclick="setPermission('panel')">Grant Panel Permission</div>
                    <div class="context-menu-item" onclick="setPermission('savescript')">Grant SaveScript Permission</div>
                    <div class="context-menu-item" onclick="setPermission('jaccept')">Grant JAccept Permission</div>
                `;
            }

            menu.innerHTML = menuItems;
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
        }

        function assignTo(path) {
            if (!currentConfig || !contextTarget) return;

            const parts = path.split('.');
            let target = currentConfig;

            for (let i = 0; i < parts.length - 1; i++) {
                if (!target[parts[i]]) target[parts[i]] = {};
                target = target[parts[i]];
            }

            target[parts[parts.length - 1]] = parseInt(contextTarget.id);

            document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 4);
            document.getElementById('contextMenu').style.display = 'none';

            showAlert('configAlert', `✓ Set ${contextTarget.name} as ${path}`, 'success');
        }

        function addToAdmins() {
            if (!currentConfig || !contextTarget) return;

            if (!currentConfig.admin_users) currentConfig.admin_users = [];
            const userId = parseInt(contextTarget.id);

            if (!currentConfig.admin_users.includes(userId)) {
                currentConfig.admin_users.push(userId);
                document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 4);
                showAlert('configAlert', `✓ Added ${contextTarget.name} to admin users`, 'success');
                renderMembers();
            }

            document.getElementById('contextMenu').style.display = 'none';
        }

        function removeFromAdmins() {
            if (!currentConfig || !contextTarget) return;

            const userId = parseInt(contextTarget.id);
            currentConfig.admin_users = currentConfig.admin_users.filter(id => id !== userId);

            document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 4);
            showAlert('configAlert', `✓ Removed ${contextTarget.name} from admin users`, 'success');
            renderMembers();

            document.getElementById('contextMenu').style.display = 'none';
        }

        function setPermission(perm) {
            if (!currentConfig || !contextTarget) return;

            if (!currentConfig.user_permissions) currentConfig.user_permissions = {};
            const userId = contextTarget.id;

            if (!currentConfig.user_permissions[userId]) {
                currentConfig.user_permissions[userId] = [];
            }

            if (!currentConfig.user_permissions[userId].includes(perm)) {
                currentConfig.user_permissions[userId].push(perm);
                document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 4);
                showAlert('configAlert', `✓ Granted ${perm} permission to ${contextTarget.name}`, 'success');
            }

            document.getElementById('contextMenu').style.display = 'none';
        }

        // Hide context menu
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').style.display = 'none';
        });

        // Filter list
        function filterList(listId, query) {
            const items = document.querySelectorAll(`#${listId} .list-item`);
            items.forEach(item => {
                const name = item.getAttribute('data-name').toLowerCase();
                item.style.display = name.includes(query.toLowerCase()) ? 'flex' : 'none';
            });
        }

        // Config management
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                currentConfig = await response.json();
                document.getElementById('clanName').value = currentConfig.clan_name || '';
                document.getElementById('configJson').value = JSON.stringify(currentConfig, null, 4);
                renderMembers(); // Re-render to show admin badges
            } catch (e) {
                showAlert('configAlert', '✗ Error loading config: ' + e.message, 'error');
            }
        }

        async function saveConfig() {
            try {
                const jsonText = document.getElementById('configJson').value;
                const config = JSON.parse(jsonText);

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.success) {
                    currentConfig = config;
                    showAlert('configAlert', '✓ Config saved and reloaded!', 'success');
                } else {
                    showAlert('configAlert', '✗ Error: ' + result.error, 'error');
                }
            } catch (e) {
                showAlert('configAlert', '✗ Error saving config: ' + e.message, 'error');
            }
        }

        // Close panel
        async function closePanel() {
            try {
                const response = await fetch('/api/panel/done', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    alert('✓ Panel closed! Config reloaded successfully.\n\nYou can close this window now.');
                } else {
                    alert('✗ Error: ' + result.error);
                }
            } catch (e) {
                alert('✗ Error: ' + e.message);
            }
        }

        // Script viewer
        async function viewScript() {
            const scriptId = document.getElementById('scriptId').value.trim();
            if (!scriptId) {
                showAlert('scriptAlert', '✗ Please enter a script ID', 'error');
                return;
            }

            try {
                const response = await fetch('/api/scripts');
                const scripts = await response.json();
                const script = scripts[scriptId];

                if (script) {
                    document.getElementById('scriptResult').innerHTML = `
                        <div class="config-card" style="margin-top: 20px;">
                            <div class="config-card-title">Script Details</div>
                            <p><strong>ID:</strong> ${scriptId}</p>
                            <p><strong>Created:</strong> ${script.timestamp || 'Unknown'}</p>
                            <p><strong>By:</strong> ${script.username || 'Unknown'}</p>
                            <div class="form-group">
                                <label class="form-label">Content</label>
                                <textarea class="form-textarea" readonly>${escapeHtml(script.content)}</textarea>
                            </div>
                            <button class="btn btn-secondary" onclick="navigator.clipboard.writeText(\`${script.content.replace(/`/g, '\\`')}\`)">Copy Content</button>
                        </div>
                    `;
                    showAlert('scriptAlert', '✓ Script found!', 'success');
                } else {
                    showAlert('scriptAlert', '✗ Script not found with ID: ' + scriptId, 'error');
                    document.getElementById('scriptResult').innerHTML = '';
                }
            } catch (e) {
                showAlert('scriptAlert', '✗ Error: ' + e.message, 'error');
            }
        }

        // Ticket viewer
        async function viewTicket() {
            const ticketId = document.getElementById('ticketId').value.trim();
            if (!ticketId) {
                showAlert('ticketAlert', '✗ Please enter a ticket ID', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                const ticket = tickets[ticketId];

                if (!ticket) {
                    showAlert('ticketAlert', '✗ Ticket not found with ID: ' + ticketId, 'error');
                    return;
                }

                document.getElementById('ticketPreview').innerHTML = `
                    <iframe srcdoc="${escapeHtml(ticket.html_content)}" style="width: 100%; height: 600px; border: 1px solid #1e1f22; border-radius: 4px; background: #fff;"></iframe>
                `;
                showAlert('ticketAlert', '✓ Ticket loaded!', 'success');
            } catch (e) {
                showAlert('ticketAlert', '✗ Error: ' + e.message, 'error');
            }
        }

        async function downloadTicket() {
            const ticketId = document.getElementById('ticketId').value.trim();
            if (!ticketId) {
                showAlert('ticketAlert', '✗ Please enter a ticket ID first', 'error');
                return;
            }

            try {
                const response = await fetch('/api/tickets');
                const tickets = await response.json();
                const ticket = tickets[ticketId];

                if (!ticket) {
                    showAlert('ticketAlert', '✗ Ticket not found', 'error');
                    return;
                }

                const blob = new Blob([ticket.html_content], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ticket-${ticketId}.html`;
                a.click();
                URL.revokeObjectURL(url);
                showAlert('ticketAlert', '✓ Ticket downloaded!', 'success');
            } catch (e) {
                showAlert('ticketAlert', '✗ Error: ' + e.message, 'error');
            }
        }

        // Helper functions
        function showAlert(elementId, message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            document.getElementById(elementId).innerHTML = `
                <div class="alert ${alertClass}">${message}</div>
            `;
            setTimeout(() => {
                document.getElementById(elementId).innerHTML = '';
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        loadServerData();
        loadConfig();
    </script>
</body>
</html>
